"use strict";var e=require("fs-extra"),t=require("url"),n=require("path"),r=require("fs"),o=require("chalk"),l=require("@babel/code-frame"),s=require("acorn");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var u=i(e),a=i(r),p=i(o),d=c(s),f=[{path:"public"},{path:"index.html"},{path:"index.css"},{path:"package.json"},{path:"package-lock.json"},{path:"settings.development.json"},{path:"settings.staging.json"},{path:"settings.test.json"},{path:"settings.production.json"},{path:".html"}];const m=new RegExp(/{([^;]*)}/g),_=new RegExp(/export default [a-zA-Z0-9]+/g),y=(e="",t={})=>{const n=a.default.readFileSync(e,"utf-8");return l.codeFrameColumns(n,{start:t})},g=(e={})=>{const t=e?.snippet?.split("\n");e.file&&(console.log("\n"),console.log(p.default.yellowBright(`Build Error in ${e?.file}:\n`))),t&&t.length>0&&t.forEach((t=>t.includes(`> ${e.line} |`)?console.log(`   ${p.default.red(t)}`):console.log(`   ${p.default.gray(t)}`))),e?.stack&&(console.log(p.default.magentaBright("\nStack Trace:\n")),console.log(`   ${((e="")=>e.replace(m,""))(e?.stack)}\n`)),process.loader.error("Build error. Fix the error above to continue building your app."),console.log("\n")},h=(e={},t="")=>{if(t&&"UNRESOLVED_IMPORT"===t){const t=e?.stack;return{file:null,snippet:null,stack:t,line:null,character:null}}if(t&&"PLUGIN_ERROR"===t){const t=e?.stack,n=Object.entries(e).reduce(((e,[t,n])=>(e[t]=n,e)),{}),r=y(e.id,{line:n?.loc?.line,column:n?.loc?.column});return{file:e.id,snippet:r,stack:t,line:n?.loc?.line,character:n?.loc?.column}}if(t&&"PARSE_ERROR"===t){const t=y(e.id,{line:e?.loc?.line,column:e?.loc?.column});return{file:e.id,snippet:t,stack:e?.parserError?.stack,line:e?.loc?.line,character:e?.loc?.column}}};var j=e=>{if("UNRESOLVED_IMPORT"===e.code&&e?.stack){const t=h(e,"UNRESOLVED_IMPORT");return g(t),t}if("PLUGIN_ERROR"===e.code&&e?.stack){const t=h(e,"PLUGIN_ERROR");return g(t),t}if("PARSE_ERROR"===e.code&&e?.stack){const t=h(e,"PARSE_ERROR");return g(t),t}};var w=(e="",t="")=>{const n=(()=>{const e=".joystick/build/fileMap.json";if(a.default.existsSync(e)){const t=a.default.readFileSync(e,"utf-8");return t?JSON.parse(t):{}}return{}})(),r=((e={})=>{const{body:t}=e,n=t&&t.filter((({type:e})=>"ImportDeclaration"===e)),r=t&&t.filter((e=>{const t="VariableDeclaration"===(e&&e.type),n=(e&&e.declarations||[]).some((e=>{const t="VariableDeclarator"===e.type,n=e&&e.init&&e.init.callee&&e.init.callee.name;return t&&"require"===n}));return t&&n}));return{imports:n.map((e=>({path:e&&e.source&&e.source.value}))),requires:r.map((e=>{const t=e.declarations,n=t&&t[0];return{path:n&&n.init&&n.init.arguments&&n.init.arguments[0]&&n.init.arguments[0].value}}))}})(((e="")=>d.parse(e,{ecmaVersion:"latest",sourceType:"module"}))(t));n[e]=r,a.default.writeFileSync(".joystick/build/fileMap.json",JSON.stringify(n,null,2))},k=()=>({transform:(e,t)=>(!["node_modules",".joystick","?","commonjsHelpers.js"].some((e=>t.includes(e)))&&w(t,e),null)});const R=t.fileURLToPath("undefined"==typeof document?new(require("url").URL)("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("buildFiles.js",document.baseURI).href),E=n.dirname(R),b=(()=>{const e=`${E.replace("/dist","/node_modules/rollup/dist/rollup.js")}`;return require(e)})(),O=((e="umd")=>{const t=`${E.replace("/dist","/node_modules")}`;return{resolve:require(`${t}/@rollup/plugin-node-resolve`).default,commonjs:require(`${t}/@rollup/plugin-commonjs`),json:require(`${t}/@rollup/plugin-json`),terser:require(`${t}/rollup-plugin-terser`).terser}})();module.exports=async(e=[])=>Promise.all(e.map((async e=>{if(f.some((t=>e.includes(t.path))))return new Promise((t=>{u.default.outputFileSync(`./.joystick/build/${e}`,u.default.readFileSync(e)),t()}));const t=((e="")=>{let t="umd";return["api/","index.server.js"].some((t=>e.includes(t)))&&(t="cjs"),t})(e);return((e="",t="umd")=>{const n={cjs:[O.json(),k(),O.commonjs({ignoreDynamicRequires:!0}),O.resolve({preferBuiltins:!0}),..."development"!==process.env.NODE_ENV?[O.terser()]:[]],umd:[O.json(),{transform(e,t){if(["pages"].some((e=>t.includes(e)))){const n=e.match(_)||[],r=n&&n[0];if(!r)return console.log(" "),console.warn(p.default.yellowBright(`All components in the ui/pages directory must have an export default statement (e.g., export default MyPage). Please check the file at ${t}.`)),console.log(" "),null;const o=(r&&r.split(" ")||[]).pop();if(o)return{code:e.replace(`${r};`,`            \n            if (\n              typeof window !== 'undefined' &&\n              window.__joystick_ssr__ === true &&\n              !window.__joystick_layout_page__ &&\n              ui &&\n              ui.mount\n            ) {\n              ui.mount(${o}, window.__joystick_ssr_props__ || {}, document.getElementById('app'));\n            }\n            \n            export default ${o};\n              `)}}return null}},{transform(e,t){if(["layouts"].some((e=>t.includes(e)))){const n=e.match(_)||[],r=n&&n[0];if(!r)return console.log(" "),console.warn(p.default.yellowBright(`All components in the ui/layouts directory must have an export default statement (e.g., export default MyLayout). Please check the file at ${t}.`)),console.log(" "),null;const o=(r&&r.split(" ")||[]).pop();if(o)return{code:e.replace(`${r};`,`if (\n                typeof window !== 'undefined' &&\n                window.__joystick_ssr__ === true &&\n                window.__joystick_layout_page__ &&\n                ui &&\n                ui.mount\n              ) {\n                fetch(window.__joystick_layout_page_url__).then(async (response) => {\n                  const file = await response.text();\n                  const component = eval(file);\n                  ui.mount(${o}, Object.assign({ ...window.__joystick_ssr_props__ }, { page: window[window.__joystick_layout_page__].js }), document.getElementById('app'));\n                });\n              }\n            \n            export default ${o};\n              `)}}return null}},k(),O.resolve(),O.commonjs({ignoreDynamicRequires:!0}),..."development"!==process.env.NODE_ENV?[O.terser()]:[]]};return b.rollup({external:["mongodb","crypto-extra","dayjs","bcrypt","chalk","nodemailer","html-to-text","juice"],input:e,onwarn:j,plugins:n[t]}).then((async n=>{if(n){const r=`.joystick/build/${e.replace("./","")}`;return a.default.existsSync(r)&&a.default.unlinkSync(r),await n.write({exports:"auto",file:`.joystick/build/${e.replace("./","")}`,name:e,format:t}),await n.close(),{success:!0,path:e}}return{success:!1,path:e}})).catch((t=>{const n=j(t);return{success:!1,path:e,error:n}}))})(e,t)})));
