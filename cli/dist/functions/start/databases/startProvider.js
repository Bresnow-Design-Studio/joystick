"use strict";var o=require("fs"),e=require("chalk"),t=require("util"),s=require("command-exists"),n=require("child_process"),a=require("mongodb");function r(o){return o&&"object"==typeof o&&"default"in o?o:{default:o}}var c=r(o),i=r(e),d=r(t),l=r(s),u=r(n);const p=d.default.promisify(u.default.exec),m=async()=>{l.default.sync("mongod")||(process.loader.stop(),console.warn(`\n  ${i.default.red("MongoDB is not installed on this computer.")}\n\n  ${i.default.green("Download MongoDB at https://www.mongodb.com/try/download/community")}\n    After you've installed MongoDB, run joystick start again, or, remove MongoDB from your databases list in your settings.development.json file to skip startup.\n  `),process.exit(1));c.default.existsSync(".joystick/data/mongodb")||c.default.mkdirSync(".joystick/data/mongodb",{recursive:!0});try{const{stdout:o}=await p(`mongod --port ${parseInt(process.env.PORT,10)+1} --dbpath ./.joystick/data/mongodb --quiet --fork --logpath ./.joystick/data/mongodb/log`);return((o=null)=>{const e=o&&o.match(/forked process:+\s[0-9]+/gi),t=e&&e[0]&&e[0].replace("forked process: ","");return t&&parseInt(t,10)})(o)}catch(o){console.warn(o),process.exit(1)}};var g=async o=>{const e=((o={})=>{let e="mongodb://";return o&&(o.username||o.password)&&(e=`${e}${o.username||""}:${o.password||""}@`),o&&o.hosts&&Array.isArray(o.hosts)&&(e=`${e}${o.hosts.map((o=>`${o.hostname}:${o.port}`)).join(",")}`),o&&o.database&&(e=`${e}/${o.database}`),e})(o);try{return(await a.MongoClient.connect(e,{connectTimeoutMS:3e3,socketTimeoutMS:3e3,useNewUrlParser:!0,useUnifiedTopology:!0,ssl:!1})).close(),!0}catch(o){console.warn(i.default.yellowBright("\nFailed to connect to MongoDB. Please double-check connection settings and try again.")),process.exit(1)}};module.exports=async(o="",e={})=>{if("mongodb"===o){process.loader.text("Starting MongoDB...");const o=e.connection&&Object.keys(e.connection).length>0;let t=null;o&&await g(e.connection),o||(t=await(async(o={})=>await m())(e));const s={hosts:[{hostname:"127.0.0.1",port:parseInt(process.env.PORT,10)+1}],database:"app",username:"",password:""},n={pid:t,connection:o?e.connection:s,settings:e};process.databases=process.databases?{...process.databases,mongodb:n}:{mongodb:n}}return Promise.resolve()};
