var J=Object.create;var y=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var Q=r=>y(r,"__esModule",{value:!0});var g=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var W=(r,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of _(e))!G.call(r,n)&&n!=="default"&&y(r,n,{get:()=>e[n],enumerable:!(t=B(e,n))||t.enumerable});return r},X=r=>W(Q(y(r!=null?J(z(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var w=g((ir,p)=>{"use strict";p.exports=r=>encodeURIComponent(r).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)});var A=g((lr,j)=>{"use strict";var S="%[a-f0-9]{2}",O=new RegExp(S,"gi"),E=new RegExp("("+S+")+","gi");function h(r,e){try{return decodeURIComponent(r.join(""))}catch{}if(r.length===1)return r;e=e||1;var t=r.slice(0,e),n=r.slice(e);return Array.prototype.concat.call([],h(t),h(n))}function K(r){try{return decodeURIComponent(r)}catch{for(var e=r.match(O),t=1;t<e.length;t++)r=h(e,t).join(""),e=r.match(O);return r}}function Y(r){for(var e={"%FE%FF":"\uFFFD\uFFFD","%FF%FE":"\uFFFD\uFFFD"},t=E.exec(r);t;){try{e[t[0]]=decodeURIComponent(t[0])}catch{var n=K(t[0]);n!==t[0]&&(e[t[0]]=n)}t=E.exec(r)}e["%C2"]="\uFFFD";for(var a=Object.keys(e),c=0;c<a.length;c++){var s=a[c];r=r.replace(new RegExp(s,"g"),e[s])}return r}j.exports=function(r){if(typeof r!="string")throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof r+"`");try{return r=r.replace(/\+/g," "),decodeURIComponent(r)}catch{return Y(r)}}});var $=g((or,N)=>{"use strict";N.exports=(r,e)=>{if(!(typeof r=="string"&&typeof e=="string"))throw new TypeError("Expected the arguments to be of type `string`");if(e==="")return[r];let t=r.indexOf(e);return t===-1?[r]:[r.slice(0,t),r.slice(t+e.length)]}});var I=g((dr,q)=>{"use strict";q.exports=function(r,e){for(var t={},n=Object.keys(r),a=Array.isArray(e),c=0;c<n.length;c++){var s=n[c],f=r[s];(a?e.indexOf(s)!==-1:e(s,f,r))&&(t[s]=f)}return t}});var L=g(l=>{"use strict";var Z=w(),v=A(),C=$(),rr=I(),er=r=>r==null,F=Symbol("encodeFragmentIdentifier");function tr(r){switch(r.arrayFormat){case"index":return e=>(t,n)=>{let a=t.length;return n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,[i(e,r),"[",a,"]"].join("")]:[...t,[i(e,r),"[",i(a,r),"]=",i(n,r)].join("")]};case"bracket":return e=>(t,n)=>n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,[i(e,r),"[]"].join("")]:[...t,[i(e,r),"[]=",i(n,r)].join("")];case"colon-list-separator":return e=>(t,n)=>n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,[i(e,r),":list="].join("")]:[...t,[i(e,r),":list=",i(n,r)].join("")];case"comma":case"separator":case"bracket-separator":{let e=r.arrayFormat==="bracket-separator"?"[]=":"=";return t=>(n,a)=>a===void 0||r.skipNull&&a===null||r.skipEmptyString&&a===""?n:(a=a===null?"":a,n.length===0?[[i(t,r),e,i(a,r)].join("")]:[[n,i(a,r)].join(r.arrayFormatSeparator)])}default:return e=>(t,n)=>n===void 0||r.skipNull&&n===null||r.skipEmptyString&&n===""?t:n===null?[...t,i(e,r)]:[...t,[i(e,r),"=",i(n,r)].join("")]}}function nr(r){let e;switch(r.arrayFormat){case"index":return(t,n,a)=>{if(e=/\[(\d*)\]$/.exec(t),t=t.replace(/\[\d*\]$/,""),!e){a[t]=n;return}a[t]===void 0&&(a[t]={}),a[t][e[1]]=n};case"bracket":return(t,n,a)=>{if(e=/(\[\])$/.exec(t),t=t.replace(/\[\]$/,""),!e){a[t]=n;return}if(a[t]===void 0){a[t]=[n];return}a[t]=[].concat(a[t],n)};case"colon-list-separator":return(t,n,a)=>{if(e=/(:list)$/.exec(t),t=t.replace(/:list$/,""),!e){a[t]=n;return}if(a[t]===void 0){a[t]=[n];return}a[t]=[].concat(a[t],n)};case"comma":case"separator":return(t,n,a)=>{let c=typeof n=="string"&&n.includes(r.arrayFormatSeparator),s=typeof n=="string"&&!c&&d(n,r).includes(r.arrayFormatSeparator);n=s?d(n,r):n;let f=c||s?n.split(r.arrayFormatSeparator).map(o=>d(o,r)):n===null?n:d(n,r);a[t]=f};case"bracket-separator":return(t,n,a)=>{let c=/(\[\])$/.test(t);if(t=t.replace(/\[\]$/,""),!c){a[t]=n&&d(n,r);return}let s=n===null?[]:n.split(r.arrayFormatSeparator).map(f=>d(f,r));if(a[t]===void 0){a[t]=s;return}a[t]=[].concat(a[t],s)};default:return(t,n,a)=>{if(a[t]===void 0){a[t]=n;return}a[t]=[].concat(a[t],n)}}}function R(r){if(typeof r!="string"||r.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function i(r,e){return e.encode?e.strict?Z(r):encodeURIComponent(r):r}function d(r,e){return e.decode?v(r):r}function U(r){return Array.isArray(r)?r.sort():typeof r=="object"?U(Object.keys(r)).sort((e,t)=>Number(e)-Number(t)).map(e=>r[e]):r}function P(r){let e=r.indexOf("#");return e!==-1&&(r=r.slice(0,e)),r}function ar(r){let e="",t=r.indexOf("#");return t!==-1&&(e=r.slice(t)),e}function D(r){r=P(r);let e=r.indexOf("?");return e===-1?"":r.slice(e+1)}function M(r,e){return e.parseNumbers&&!Number.isNaN(Number(r))&&typeof r=="string"&&r.trim()!==""?r=Number(r):e.parseBooleans&&r!==null&&(r.toLowerCase()==="true"||r.toLowerCase()==="false")&&(r=r.toLowerCase()==="true"),r}function H(r,e){e=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},e),R(e.arrayFormatSeparator);let t=nr(e),n=Object.create(null);if(typeof r!="string"||(r=r.trim().replace(/^[?#&]/,""),!r))return n;for(let a of r.split("&")){if(a==="")continue;let[c,s]=C(e.decode?a.replace(/\+/g," "):a,"=");s=s===void 0?null:["comma","separator","bracket-separator"].includes(e.arrayFormat)?s:d(s,e),t(d(c,e),s,n)}for(let a of Object.keys(n)){let c=n[a];if(typeof c=="object"&&c!==null)for(let s of Object.keys(c))c[s]=M(c[s],e);else n[a]=M(c,e)}return e.sort===!1?n:(e.sort===!0?Object.keys(n).sort():Object.keys(n).sort(e.sort)).reduce((a,c)=>{let s=n[c];return Boolean(s)&&typeof s=="object"&&!Array.isArray(s)?a[c]=U(s):a[c]=s,a},Object.create(null))}l.extract=D;l.parse=H;l.stringify=(r,e)=>{if(!r)return"";e=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},e),R(e.arrayFormatSeparator);let t=s=>e.skipNull&&er(r[s])||e.skipEmptyString&&r[s]==="",n=tr(e),a={};for(let s of Object.keys(r))t(s)||(a[s]=r[s]);let c=Object.keys(a);return e.sort!==!1&&c.sort(e.sort),c.map(s=>{let f=r[s];return f===void 0?"":f===null?i(s,e):Array.isArray(f)?f.length===0&&e.arrayFormat==="bracket-separator"?i(s,e)+"[]":f.reduce(n(s),[]).join("&"):i(s,e)+"="+i(f,e)}).filter(s=>s.length>0).join("&")};l.parseUrl=(r,e)=>{e=Object.assign({decode:!0},e);let[t,n]=C(r,"#");return Object.assign({url:t.split("?")[0]||"",query:H(D(r),e)},e&&e.parseFragmentIdentifier&&n?{fragmentIdentifier:d(n,e)}:{})};l.stringifyUrl=(r,e)=>{e=Object.assign({encode:!0,strict:!0,[F]:!0},e);let t=P(r.url).split("?")[0]||"",n=l.extract(r.url),a=l.parse(n,{sort:!1}),c=Object.assign(a,r.query),s=l.stringify(c,e);s&&(s=`?${s}`);let f=ar(r.url);return r.fragmentIdentifier&&(f=`#${e[F]?i(r.fragmentIdentifier,e):r.fragmentIdentifier}`),`${t}${s}${f}`};l.pick=(r,e,t)=>{t=Object.assign({parseFragmentIdentifier:!0,[F]:!1},t);let{url:n,query:a,fragmentIdentifier:c}=l.parseUrl(r,t);return l.stringifyUrl({url:n,query:rr(a,e),fragmentIdentifier:c},t)};l.exclude=(r,e,t)=>{let n=Array.isArray(e)?a=>!e.includes(a):(a,c)=>!e(a,c);return l.pick(r,n,t)}});var x=(r=16)=>{let e=[],t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];for(let n=0;n<r;n++)e.push(t[Math.floor(Math.random()*16)]);return e.join("")};var b=(r="",e=[])=>{console.log(`%c\u274C ${r} failed with the following errors:`,'background-color: #ffcc00; padding: 7px; font-family: "Helvetica Neue", "Helvetica", "Arial", sans-serif; font-size: 13px; line-height: 13px; color: #000;'),e.forEach(t=>{console.log(t.message),t.stack&&console.log(t.stack)})};var T=X(L()),u=null,m=0,k=(r={},e=null)=>{let t=r?.url;r.queryParams&&(t=`${t}?${T.default.stringify(r.queryParams)}`);let n=new WebSocket(t);u&&(clearInterval(u),u=null),n.addEventListener("open",()=>{r?.logging&&console.log(`[websockets] Connected to ${r?.url}`),m=0}),n.addEventListener("message",c=>{c?.data&&r.onMessage&&r.onMessage(JSON.parse(c.data))}),n.addEventListener("close",()=>{r?.logging&&console.log(`[websockets] Disconnected from ${r?.url}`),n=null,r.autoReconnect&&!u&&(u=setInterval(()=>{n=null,m<12?(k(r,e),r?.logging&&console.log(`[websockets] Attempting to reconnect (${m+1}/12)...`),m+=1):clearInterval(u)},5e3))});let a={client:n,send:(c={})=>(r.queryParams&&(c={...c,...r.queryParams}),n.send(JSON.stringify(c)))};return e&&e(a),a},V=k;var Fr=(r="",e={})=>new Promise((t,n)=>{let a=x(),c=0;V({url:`${window?.process?.env.NODE_ENV==="development"?"ws":"wss"}://${location.host}/api/_websockets/uploaders`,queryParams:{id:a},onMessage:(s={})=>{s?.type==="PROGRESS"&&e?.onProgress&&c<100&&c!==s?.progress&&(c=s?.progress,e.onProgress(s?.progress,s?.provider))}},()=>{let s;e?.files?.length>0&&(s=new FormData,Array.from(e?.files).forEach(o=>{s.append("files",o,o.name)}));let f=new XMLHttpRequest;f.onload=()=>{let o=f.responseText?JSON.parse(f.responseText):null;o&&o.errors?(b("upload",o.errors),n(o.errors)):t(o?.uploads)},f.open("POST",`${window.location.origin}/api/_uploaders/${r}`),f.setRequestHeader("x-joystick-upload-id",a),f.setRequestHeader("x-joystick-upload-input",JSON.stringify(e?.input||{})),f.send(s)})});export{Fr as default};
